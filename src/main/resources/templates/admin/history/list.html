<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}">

<head>
    <title>ê´€ë¦¬ì ë¡œê·¸ ë¦¬ìŠ¤íŠ¸</title>
</head>

<body>
<main layout:fragment="content">
    <div class="container card mt-4 mb-4">
        <h2 class="mb-4 mt-4">ğŸ“Š ê´€ë¦¬ì ë¡œê·¸ ë¦¬ìŠ¤íŠ¸</h2>
        <div class="card p-4 mb-4">
            <h5 class="mb-3">ğŸ“ˆ ê´€ë¦¬ì ë¡œê·¸ í†µê³„</h5>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <h6>ê´€ë¦¬ìë³„ ë¡œê·¸</h6>
                    <canvas id="adminChart"></canvas>
                </div>
                <div class="col-md-6 mb-4">
                    <h6>ì¼ìë³„ ë¡œê·¸</h6>
                    <canvas id="weekChart"></canvas>
                </div>
                <div class="col-md-6 mb-4" style="max-width: 400px; margin: 0 auto;">
                    <h6>í–‰ë™ìœ í˜•ë³„ í†µê³„</h6>
                    <canvas id="actionChart"></canvas>
                </div>
                <div class="col-md-6 mb-4">
                    <h6>ì›”ë³„ ë¡œê·¸</h6>
                    <canvas id="monthChart"></canvas>
                </div>
            </div>
        </div>

        <h5 class="mt-3" id="searchList">ğŸ“ˆ ê´€ë¦¬ì ë¡œê·¸ ê²€ìƒ‰</h5>
        <div class="d-flex justify-content-end align-items-center mb-2 px-2">
            <strong class="me-2">ì´ ë¡œê·¸ ìˆ˜:</strong>
            <span class="badge bg-primary fs-6" th:text="${logCount} + 'ê±´'">0ê±´</span>
        </div>
        <form th:action="@{/admin/history/list} + '#searchList'" method="get" class="row g-3 align-items-center mb-4">
            <div class="col-md-3 col-sm-6">
                <label for="adminId" class="form-label visually-hidden">ê´€ë¦¬ì ID</label>
                <input type="text" name="adminId" id="adminId" placeholder="ê´€ë¦¬ì ID"
                       th:value="${search['adminId']}" class="form-control"/>
            </div>

            <div class="col-md-3 col-sm-6">
                <label for="targetTable" class="form-label visually-hidden">í…Œì´ë¸”ëª…</label>
                <input type="text" name="targetTable" id="targetTable" placeholder="í…Œì´ë¸”ëª…"
                       th:value="${search['targetTable']}" class="form-control"/>
            </div>

            <div class="col-md-2 col-sm-6">
                <label for="startDate" class="form-label visually-hidden">ì‹œì‘ì¼</label>
                <input type="date" name="startDate" id="startDate" th:value="${search['startDate']}"
                       class="form-control"/>
            </div>

            <div class="col-md-2 col-sm-6">
                <label for="endDate" class="form-label visually-hidden">ì¢…ë£Œì¼</label>
                <input type="date" name="endDate" id="endDate" th:value="${search['endDate']}" class="form-control"/>
            </div>

            <div class="col-md-2 col-sm-12 d-flex align-items-center gap-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> ê²€ìƒ‰
                </button>
                <a th:href="@{/admin/history/list} + '#searchList'" class="btn btn-secondary w-100">
                    <i class="bi bi-arrow-counterclockwise"></i> ì´ˆê¸°í™”
                </a>
            </div>

            <div class="col-12 mt-3">
                <label class="form-label mb-2">í–‰ë™ ìœ í˜•</label>
                <div class="d-flex flex-wrap gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="actionType" id="actionAll" value=""
                               th:checked="${search['actionType'] == null or search['actionType'] == ''}"/>
                        <label class="form-check-label" for="actionAll">
                            <span class="badge bg-secondary">ì „ì²´</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="actionType" id="actionInsert" value="INSERT"
                               th:checked="${search['actionType'] == 'INSERT'}"/>
                        <label class="form-check-label" for="actionInsert">
                            <span class="badge bg-warning text-dark">INSERT</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="actionType" id="actionUpdate" value="UPDATE"
                               th:checked="${search['actionType'] == 'UPDATE'}"/>
                        <label class="form-check-label" for="actionUpdate">
                            <span class="badge bg-info text-dark">UPDATE</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="actionType" id="actionDelete" value="DELETE"
                               th:checked="${search['actionType'] == 'DELETE'}"/>
                        <label class="form-check-label" for="actionDelete">
                            <span class="badge bg-danger">DELETE</span>
                        </label>
                    </div>
                </div>
            </div>

        </form>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-warning rounded-3">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">í–‰ë™ ìœ í˜•</th>
                    <th scope="col">ëŒ€ìƒ í…Œì´ë¸”</th>
                    <th scope="col">ëŒ€ìƒ ì´ë¦„</th>
                    <th scope="col">ì„¤ëª…</th>
                    <th scope="col">ê´€ë¦¬ì ID</th>
                    <th scope="col">ìƒì„± ì¼ì‹œ</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${#lists.isEmpty(logs)}">
                    <td colspan="7" class="text-center text-muted">ë¡œê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                <tr th:each="log : ${logs}">
                    <td th:text="${log.logId}">1</td>
                    <td>
                    <span th:classappend="|
                        badge
                        ${log.actionType == 'INSERT' ? 'bg-warning text-dark' :
                          log.actionType == 'UPDATE' ? 'bg-info text-dark' :
                          log.actionType == 'DELETE' ? 'bg-danger' : 'bg-secondary'}|"
                          th:text="${log.actionType}">
                    </span>
                    </td>
                    <td th:text="${log.targetTable}">menu</td>
                    <td th:text="${log.targetName != '' ? log.targetName : 'ì—†ìŒ'}">ëŒ€ìƒ ì—†ìŒ</td>
                    <td th:text="${log.description != null ? log.description : '-'}">-</td>
                    <td th:text="${log.adminId}">admin01</td>
                    <td th:text="${#temporals.format(log.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center mt-4">
                <!-- ì´ì „ í˜ì´ì§€ ë²„íŠ¼ -->
                <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                    <a class="page-link" th:href="@{/admin/history/list(page=${currentPage - 1}, size=${size},
    adminId=${search['adminId']}, targetTable=${search['targetTable']},
    startDate=${search['startDate']}, endDate=${search['endDate']},
    actionType=${search['actionType']})} + '#searchList'" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(1, totalPages > 0 ? totalPages : 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{/admin/history/list(page=${i}, size=${size},
        adminId=${search['adminId']}, targetTable=${search['targetTable']},
        startDate=${search['startDate']}, endDate=${search['endDate']},
        actionType=${search['actionType']})} + '#searchList'"
                       th:text="${i}">1</a>
                </li>

                <!-- ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ -->
                <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                    <a class="page-link" th:href="@{/admin/history/list(page=${currentPage + 1}, size=${size},
                adminId=${search['adminId']}, targetTable=${search['targetTable']},
                startDate=${search['startDate']}, endDate=${search['endDate']},
                actionType=${search['actionType']})} + '#searchList'" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</main>

<script layout:fragment="script" th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('input[name="actionType"]').forEach(radio => {
            radio.addEventListener('change', () => {
                radio.closest('form').submit();
            });
        });
    });

    // ê´€ë¦¬ìë³„ ë¡œê·¸: ë§‰ëŒ€ ê·¸ë˜í”„ (Bar)
    const adminChart = new Chart(document.getElementById('adminChart'), {
        type: 'bar',
        data: {
            labels: /*[[${adminLabels}]]*/,
            datasets: [{
                label: 'ë¡œê·¸ ìˆ˜',
                data: /*[[${adminCounts}]]*/,
                backgroundColor: 'rgba(92,248,64,0.5)',
                maxBarThickness: 30 // ìµœëŒ€ ë§‰ëŒ€ ë‘ê»˜ ì œí•œ
            }]
        }
    });

    // ì¼ìë³„ ë¡œê·¸: ì„  ê·¸ë˜í”„ (Line)
    const weekChart = new Chart(document.getElementById('weekChart'), {
        type: 'line',
        data: {
            labels: /*[[${weekLabels}]]*/,
            datasets: [{
                label: 'ì¼ë³„ ë¡œê·¸ ìˆ˜',
                data: /*[[${weekCounts}]]*/,
                backgroundColor: 'rgba(75, 192, 192, 0.4)',
                borderColor: 'rgba(75, 192, 192, 1)',
                fill: false,
                tension: 0.3
            }]
        }
    });

    // í–‰ë™ìœ í˜•ë³„ í†µê³„: ë„ë„› ì°¨íŠ¸ (Doughnut)
    const actionChart = new Chart(document.getElementById('actionChart'), {
        type: 'doughnut',
        data: {
            labels: /*[[${actionLabels}]]*/,
            datasets: [{
                label: 'ìœ í˜•ë³„ ë¹„ìœ¨',
                data: /*[[${actionCounts}]]*/,
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(75, 192, 192, 0.6)'
                ]
            }]
        }
    });

    // ì›”ë³„ ë¡œê·¸: ì˜ì—­ ê·¸ë˜í”„ (Area)
    const monthChart = new Chart(document.getElementById('monthChart'), {
        type: 'line',
        data: {
            labels: /*[[${monthLabels}]]*/,
            datasets: [{
                label: 'ì›”ë³„ ë¡œê·¸ ìˆ˜',
                data: /*[[${monthCounts}]]*/,
                backgroundColor: 'rgba(153, 102, 255, 0.4)',
                borderColor: 'rgba(153, 102, 255, 1)',
                fill: true,  // ì˜ì—­ ê·¸ë˜í”„ë¡œ ì±„ì›€
                tension: 0.3
            }]
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}">

<head>
    <title>ÎåÄÏãúÎ≥¥Îìú</title>
</head>

<main layout:fragment="content">
    <div th:if="${soldOutCount > 0 || lowStockCount > 0}" class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
        <div>
            üõë Ï¥ù <strong th:text="${soldOutCount + lowStockCount}">0</strong>Í∞ú ÌíàÏ†à/Ïû¨Í≥† Î∂ÄÏ°± Î©îÎâ¥Í∞Ä ÏûàÏäµÎãàÎã§.
            (<span th:if="${soldOutCount > 0}">ÌíàÏ†à <strong th:text="${soldOutCount}">0</strong>Í∞ú</span>
            <span th:if="${soldOutCount > 0 && lowStockCount > 0}">, </span>
            <span th:if="${lowStockCount > 0}">Ïû¨Í≥† Î∂ÄÏ°± <strong th:text="${lowStockCount}">0</strong>Í∞ú</span>)
        </div>
        <a th:href="@{/admin/menu/list}" class="btn btn-sm btn-outline-primary ms-auto">Ïû¨Í≥† Í¥ÄÎ¶¨ Î∞îÎ°úÍ∞ÄÍ∏∞</a>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- ÏßÑÌñâÏ§ë Ï£ºÎ¨∏ -->
            <div class="col-md-4 mb-3">
                <div class="card text-dark shadow-sm rounded-3" style="background-color: #ffecb3;">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="bi bi-clock me-2"></i> ÏßÑÌñâÏ§ë Ï£ºÎ¨∏
                        </h5>
                        <p class="card-text h4 mb-0" th:text="${waitingCount}">0</p>
                    </div>
                </div>
            </div>

            <!-- ÏôÑÎ£å Ï£ºÎ¨∏ -->
            <div class="col-md-4 mb-3">
                <div class="card text-dark shadow-sm rounded-3" style="background-color: #b2dfdb;">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="bi bi-check-circle me-2"></i> ÏôÑÎ£å Ï£ºÎ¨∏
                        </h5>
                        <p class="card-text h4 mb-0" th:text="${completeCount}">0</p>
                    </div>
                </div>
            </div>

            <!-- Ï∑®ÏÜå Ï£ºÎ¨∏ -->
            <div class="col-md-4 mb-3">
                <div class="card text-dark shadow-sm rounded-3" style="background-color: #ffcccc;">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="bi bi-x-circle me-2"></i> Ï∑®ÏÜå Ï£ºÎ¨∏
                        </h5>
                        <p class="card-text h4 mb-0" th:text="${cancelledCount}">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm rounded-3 border-0" style="background-color: #fff3e0;">
            <div class="card-header text-dark border-bottom-0" style="background-color: #ffe0b2;">
                <strong>ÏßÑÌñâÏ§ë Ï£ºÎ¨∏ Î¶¨Ïä§Ìä∏</strong>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped mb-0 text-center">
                        <thead class="table-light">
                        <tr>
                            <th>Ï£ºÎ¨∏Î≤àÌò∏</th>
                            <th>Ï†ÑÌôîÎ≤àÌò∏</th>
                            <th>Ï£ºÎ¨∏ÏùºÏãú</th>
                            <th>Ï¥ù Í≤∞Ï†úÍ∏àÏï°</th>
                            <th>Ï£ºÎ¨∏ Î∞©Ïãù</th>
                            <th>ÏÉÅÌÉú</th>
                            <th>ÏôÑÎ£å</th>
                            <th>Ï∑®ÏÜå</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="order : ${waitingOrders}">
                            <td>
                                <a href="#" th:text="${order.orderId}"
                                   data-bs-toggle="modal"
                                   th:attr="data-bs-target='#orderModal__' + ${order.orderId}"></a>
                            </td>
                            <td th:text="${order.phone}">010-xxxx-xxxx</td>
                            <td th:text="${#temporals.format(order.orderTime, 'yyyy-MM-dd HH:mm')}">2025-07-31 10:00</td>
                            <td th:text="${#numbers.formatInteger(order.totalAmount, 3, 'COMMA')}">5,000</td>
                            <td th:text="${order.orderMethod}">KIOSK</td>
                            <td th:text="${order.status}">WAITING</td>
                            <td>
                                <form th:action="@{/admin/order/complete}" method="post">
                                    <input type="hidden" name="orderId" th:value="${order.orderId}" />
                                    <button type="submit" class="btn btn-sm rounded-pill" style="background-color: #8bc34a; color: white;">
                                        ÏôÑÎ£å
                                    </button>
                                </form>
                            </td>
                            <td>
                                <form th:action="@{/admin/order/cancel}" method="post">
                                    <input type="hidden" name="orderId" th:value="${order.orderId}" />
                                    <button type="submit" class="btn btn-sm rounded-pill" style="background-color: #f44336; color: white;">
                                        Ï∑®ÏÜå
                                    </button>
                                </form>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(waitingOrders)}">
                            <td colspan="8">ÏßÑÌñâÏ§ëÏù∏ Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card text-dark shadow-sm rounded-3" style="background-color: #ffecb3;">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-bar-chart me-2"></i> Ïò§Îäò Îß§Ï∂ú
                        </h5>
                        <p class="card-text h4 mb-0" th:text="'‚Ç© ' + ${#numbers.formatInteger(todaySales, 3, 'COMMA')}">‚Ç© 0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-dark shadow-sm rounded-3" style="background-color: #b2dfdb;">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-calendar-event me-2"></i> Ïù¥Î≤à Îã¨ Îß§Ï∂ú
                        </h5>
                        <p class="card-text h4 mb-0" th:text="'‚Ç© ' + ${#numbers.formatInteger(monthSales, 3, 'COMMA')}">‚Ç© 0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-dark shadow-sm rounded-3" style="background-color: #ffcccc;">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-calendar-event me-2"></i> Ïò¨Ìï¥ Îß§Ï∂ú
                        </h5>
                        <p class="card-text h4 mb-0" th:text="'‚Ç© ' + ${#numbers.formatInteger(yearSales, 3, 'COMMA')}">‚Ç© 0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm rounded-3">
                    <div class="card-header text-dark" style="background-color: #ffe0b2;">
                        <strong><i class="bi bi-clock me-2"></i>Í∏àÏùº ÏãúÍ∞ÑÎåÄÎ≥Ñ Îß§Ï∂ú Ï∞®Ìä∏ (AM / PM)</strong>
                    </div>
                    <div class="card-body">
                        <canvas id="hourlySalesChart" height="157"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4" style="max-height: 490px; overflow-y: auto;">
                <div class="card shadow-sm rounded-3">
                    <div class="card-header text-dark" style="background-color: #ffe0b2;">
                        <strong>Í∏àÏùº ÏãúÍ∞ÑÎåÄÎ≥Ñ Îß§Ï∂ú ÏÉÅÏÑ∏ Î¶¨Ïä§Ìä∏</strong>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped mb-0 text-center">
                                <thead class="table-light">
                                <tr>
                                    <th>ÏãúÍ∞Ñ</th>
                                    <th>Ï£ºÎ¨∏ Ïàò</th>
                                    <th>Ï¥ù Îß§Ï∂ú (‚Ç©)</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="sale : ${hourlySales}">
                                    <td th:text="${sale.hour} + 'Ïãú'">10Ïãú</td>
                                    <td th:text="${sale.orderCount}">0</td>
                                    <td th:text="${#numbers.formatInteger(sale.totalSales, 3, 'COMMA')}">0</td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(hourlySales)}">
                                    <td colspan="3" class="text-center">Îß§Ï∂ú Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:each="order : ${waitingOrders}"
             th:id="'orderModal__' + ${order.orderId}"
             class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" th:text="'Ï£ºÎ¨∏ ÏÉÅÏÑ∏ - Ï£ºÎ¨∏Î≤àÌò∏: ' + ${order.orderId}"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Îã´Í∏∞"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered">
                            <thead class="table-secondary">
                            <tr>
                                <th>Î©îÎâ¥Î™Ö</th>
                                <th>ÏòµÏÖò</th>
                                <th>ÏàòÎüâ</th>
                                <th>Í∞ÄÍ≤©</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${order.orderItemList}">
                                <td th:text="${item.menuDTO.name}">ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏</td>
                                <td>
  <span th:each="opt : ${item.optionList}">
    <span th:text="|${opt.optionName} (+${#numbers.formatInteger(opt.optionPrice, 3, 'COMMA')}Ïõê)|"></span><br/>
  </span>
                                </td>

                                <td th:text="${item.quantity}">2</td>
                                <td th:text="|${#numbers.formatInteger(item.price, 3, 'COMMA')}Ïõê|">5,000Ïõê</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<script layout:fragment="script" th:inline="javascript">
    const hourlySalesData = /*[[${hourlySales}]]*/ [];

    const amLabels = Array.from({length: 12}, (_, i) => (i === 0 ? '12Ïãú' : `${i}Ïãú`));
    const salesMap = {};
    hourlySalesData.forEach(s => {
        salesMap[s.hour] = s.totalSales;
    });

    // Ïò§Ï†Ñ ‚Üí Ïã§Ï†ú 0~11Ïãú Îç∞Ïù¥ÌÑ∞
    const amSales = Array.from({length: 12}, (_, i) => salesMap[i] || 0);
    // Ïò§ÌõÑ ‚Üí 12~23ÏãúÎ•º Îã§Ïãú 0~11Ïóê Îß§Ìïë (Ïòà: 12ÏãúÎäî index 0, 13ÏãúÎäî index 1...)
    const pmSales = Array.from({length: 12}, (_, i) => salesMap[i + 12] || 0);

    const ctx = document.getElementById("hourlySalesChart").getContext("2d");
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: amLabels, // xÏ∂ïÏùÄ Ìï≠ÏÉÅ 0~11Ïãú
            datasets: [
                {
                    label: "Ïò§Ï†Ñ Îß§Ï∂ú (‚Ç©)",
                    data: amSales,
                    borderColor: '#f48fb1',
                    backgroundColor: 'rgba(251, 233, 231, 0.5)',
                    fill: true,
                    tension: 0.3,
                },
                {
                    label: "Ïò§ÌõÑ Îß§Ï∂ú (‚Ç©)",
                    data: pmSales,
                    borderColor: '#ffb74d',
                    backgroundColor: 'rgba(255, 243, 224, 0.5)',
                    fill: true,
                    tension: 0.3,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {display: true},
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return "‚Ç© " + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {display: true, text: 'ÏãúÍ∞Ñ'},
                },
                y: {
                    title: {display: true, text: 'Îß§Ï∂úÏï° (‚Ç©)'},
                    beginAtZero: true,
                    ticks: {
                        callback: val => '‚Ç©' + val.toLocaleString()
                    }
                }
            }
        }
    });
</script>
</html>